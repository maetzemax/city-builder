[gd_scene load_steps=27 format=3 uid="uid://ble25xwm6dllu"]

[ext_resource type="PackedScene" uid="uid://df0b08mdpd7kn" path="res://scenes/models/environment/terrain.tscn" id="1_fe2o3"]
[ext_resource type="PackedScene" uid="uid://djkhxkdyic626" path="res://scenes/ui/navigation_button.tscn" id="1_uhagc"]
[ext_resource type="PackedScene" uid="uid://dvd53runfr5vs" path="res://scenes/main.tscn" id="2_wb0q5"]
[ext_resource type="PackedScene" uid="uid://bn2j568mwjyxb" path="res://scenes/models/buildings/residential_placeholder.tscn" id="3_m1kxf"]
[ext_resource type="FontFile" uid="uid://chv1w8s37w8t7" path="res://assets/fonts/Jersey15-Regular.ttf" id="3_q85j6"]
[ext_resource type="Script" uid="uid://bvd3ryegodarr" path="res://scripts/ui/exit_button.gd" id="4_q85j6"]
[ext_resource type="PackedScene" uid="uid://bmglwbl6r4ao7" path="res://scenes/models/buildings/tree1.tscn" id="4_x2yvf"]
[ext_resource type="PackedScene" uid="uid://cdw4atnef81ew" path="res://scenes/models/buildings/lumber_hut.tscn" id="5_x2yvf"]
[ext_resource type="Resource" uid="uid://b0mbm2nb4pntn" path="res://assets/game_night_cycle.tres" id="11_otr3d"]
[ext_resource type="Script" uid="uid://c85ddrpo5m0rc" path="res://scripts/environment/world_environment.gd" id="12_n4uci"]
[ext_resource type="Texture2D" uid="uid://bpoucta1iqcrr" path="res://assets/day_sky_cover.jpg" id="13_877pj"]
[ext_resource type="Texture2D" uid="uid://dhevk6s213jhd" path="res://assets/night_sky_cover.jpg" id="14_ayp64"]

[sub_resource type="StyleBoxFlat" id="StyleBoxFlat_8g5eo"]
content_margin_left = 24.0
content_margin_top = 12.0
content_margin_right = 24.0
content_margin_bottom = 12.0
bg_color = Color(0.22520697, 0.20444673, 0.22192162, 1)
border_width_left = 1
border_width_top = 1
border_width_right = 1
border_width_bottom = 1
border_blend = true
corner_radius_top_left = 12
corner_radius_top_right = 12
corner_radius_bottom_right = 12
corner_radius_bottom_left = 12

[sub_resource type="StyleBoxFlat" id="StyleBoxFlat_wb0q5"]
content_margin_left = 24.0
content_margin_top = 12.0
content_margin_right = 24.0
content_margin_bottom = 12.0
bg_color = Color(0.2784314, 0.25490198, 0.27450982, 1)
border_width_left = 1
border_width_top = 1
border_width_right = 1
border_width_bottom = 1
border_blend = true
corner_radius_top_left = 12
corner_radius_top_right = 12
corner_radius_bottom_right = 12
corner_radius_bottom_left = 12

[sub_resource type="StyleBoxFlat" id="StyleBoxFlat_q85j6"]
content_margin_left = 24.0
content_margin_top = 12.0
content_margin_right = 24.0
content_margin_bottom = 12.0
bg_color = Color(0.2784314, 0.25490198, 0.27450982, 1)
border_width_left = 1
border_width_top = 1
border_width_right = 1
border_width_bottom = 1
border_blend = true
corner_radius_top_left = 12
corner_radius_top_right = 12
corner_radius_bottom_right = 12
corner_radius_bottom_left = 12

[sub_resource type="StyleBoxFlat" id="StyleBoxFlat_7suek"]
content_margin_left = 24.0
content_margin_top = 12.0
content_margin_right = 24.0
content_margin_bottom = 12.0
bg_color = Color(0.7, 0.7, 0.7, 1)
border_width_left = 1
border_width_top = 1
border_width_right = 1
border_width_bottom = 1
border_blend = true
corner_radius_top_left = 12
corner_radius_top_right = 12
corner_radius_bottom_right = 12
corner_radius_bottom_left = 12

[sub_resource type="StyleBoxFlat" id="StyleBoxFlat_otr3d"]
content_margin_left = 24.0
content_margin_top = 12.0
content_margin_right = 24.0
content_margin_bottom = 12.0
bg_color = Color(0.22520697, 0.20444673, 0.22192162, 1)
border_width_left = 3
border_width_top = 3
border_width_right = 3
border_width_bottom = 3
border_blend = true
corner_radius_top_left = 12
corner_radius_top_right = 12
corner_radius_bottom_right = 12
corner_radius_bottom_left = 12

[sub_resource type="GDScript" id="GDScript_tel4y"]
script/source = "class_name CycleController
extends Node3D

signal day_started
signal night_started

#region Export
@export_group(\"Presets\")
@export var day_data: CycleData
@export var night_data: CycleData

@export_group(\"General\")
@export var sun_light: DirectionalLight3D
@export var world_environment: WorldEnvironment

@export_group(\"Debug\")
@export var show_debug_time: bool = false
#endregion

var _current_time: float = 0.0
var _cycle_time: float = 0.0
var _is_day: bool = true


func _ready():
	_cycle_time = day_data.length + night_data.length


func _process(delta):
	_current_time += delta
	
	var previous_is_day = _is_day
	
	if _current_time < day_data.length:
		_is_day = true
	else:
		_is_day = false
	
	if previous_is_day != _is_day:
		if _is_day:
			day_started.emit()
		else:
			night_started.emit()
	
	if _current_time >= _cycle_time:
		_current_time = 0.0
		_is_day = true
		day_started.emit()
	
	var progress: float
	if _is_day:
		progress = _current_time / day_data.length
	else:
		progress = (_current_time - day_data.length) / night_data.length
	
	progress = clamp(progress, 0.0, 1.0)
	
	var day_light_energy = day_data.light_energy.sample(progress)
	var night_light_energy = night_data.light_energy.sample(progress)	
	
	sun_light.light_energy = day_light_energy if _is_day else night_light_energy
	
	var sky_color: Color
	if _is_day:
		sky_color = day_data.colors.gradient.sample(progress)
	else:
		sky_color = night_data.colors.gradient.sample(progress)
	
	if world_environment.environment and world_environment.environment.sky:
		var sky_material = world_environment.environment.sky.sky_material
		if sky_material:
			sky_material.sky_top_color = sky_color.lightened(0.1)
			sky_material.sky_horizon_color = sky_color
			sky_material.ground_bottom_color = sky_color.darkened(0.1)
			sky_material.ground_horizon_color = sky_color.darkened(0.2)
	else:
		push_warning(\"Could not find sky material. Please assign WorldEnvironment accrodingly. Need Help? Look for 'Setup' in the README file.\")
	
	var angle: float
	if _is_day:
		angle = progress * 180.0  # 0° → 180°
	else:
		angle = progress * 180.0 + 180.0  # 180° → 360°
	
	sun_light.rotation_degrees.x = -angle
	
	# Debug Info
	if show_debug_time:
		_print_debug_info()


## Formated time string (hh:mm:ss) since entering the tree.
func get_current_time_formatted() -> String:
	var hours = int(_current_time / 3600.0)
	var minutes = int(fmod(_current_time, 3600.0) / 60.0)
	var seconds = int(fmod(_current_time, 60.0))
	return \"%02d:%02d:%02d\" % [hours, minutes, seconds]


## Normalized progress [0.0, 1.0] of the whole cycle (day + night).
func get_cycle_progress() -> float:
	return (_current_time / _cycle_time)


## Normalized progress [0.0, 1.0] of current phase (day OR night).
func get_phase_progress() -> float:
	if _is_day:
		return _current_time / day_data.length
	else:
		return (_current_time - day_data.length) / night_data.length


## Jump to any state of the cycle.
## @param progress Value from 0.0 (Start) to 1.0 (End) of the cylces progress.
func set_cycle_progress(progress: float):
	_current_time = progress * _cycle_time
	_current_time = clamp(_current_time, 0.0, _cycle_time)


## Jump to begin of the day.
func skip_to_day():
	_current_time = 0.0
	_is_day = true
	day_started.emit()


## Jump to begin of the night.
func skip_to_night():
	_current_time = day_data.length
	_is_day = false
	night_started.emit()


func _print_debug_info():
	var cycle_progress = get_cycle_progress() * 100
	var phase = \"Day\" if _is_day else \"Night\"
	var phase_progress = get_phase_progress() * 100
	
	print(\"Time: %s | Cycle: %.1f%% | Phase: %s (%.1f%%)\" % [
		get_current_time_formatted(),
		cycle_progress,
		phase,
		phase_progress,
	])
"

[sub_resource type="Gradient" id="Gradient_u4ray"]
offsets = PackedFloat32Array(0, 0.2, 0.8, 1)
colors = PackedColorArray(0.8374334, 0.48671246, 0.4633525, 1, 0.245, 0.68599993, 0.98, 1, 0.29400003, 0.69416684, 0.98, 1, 0.8392157, 0.40784314, 0.4627451, 1)
metadata/_snap_enabled = true

[sub_resource type="GradientTexture2D" id="GradientTexture2D_d15nv"]
gradient = SubResource("Gradient_u4ray")
metadata/_snap_enabled = true

[sub_resource type="Curve" id="Curve_o3ut8"]
_data = [Vector2(0, 0.5), 0.0, 0.0, 0, 0, Vector2(0.5, 1), 0.0, 0.0, 0, 0, Vector2(1, 0.5), 0.0, 0.0, 0, 0]
point_count = 3

[sub_resource type="GDScript" id="GDScript_otr3d"]
script/source = "extends Resource

class_name CycleData

## Represent the colors on the sky during the day cycle.
## Colors aligned on the left are the morning-light.
## Colors on the right are the end-of-day light.
@export var colors: GradientTexture2D

## Length of the day in seconds.
@export var length: float

## Control the sun lights enegry during the day.
@export var light_energy: Curve
"

[sub_resource type="Resource" id="Resource_n4uci"]
script = SubResource("GDScript_otr3d")
colors = SubResource("GradientTexture2D_d15nv")
length = 72000.0
light_energy = SubResource("Curve_o3ut8")
metadata/_custom_type_script = "uid://kolqah11th63"

[sub_resource type="ProceduralSkyMaterial" id="ProceduralSkyMaterial_n4uci"]
sky_top_color = Color(0.5990235, 0.66700757, 0.74295527, 1)
sky_horizon_color = Color(0.69806564, 0.71506166, 0.7340486, 1)
sky_cover = ExtResource("13_877pj")
sun_angle_max = 15.0

[sub_resource type="Sky" id="Sky_muem4"]
sky_material = SubResource("ProceduralSkyMaterial_n4uci")

[sub_resource type="Environment" id="Environment_877pj"]
background_mode = 2
sky = SubResource("Sky_muem4")
ambient_light_source = 2
tonemap_mode = 3
tonemap_exposure = 0.5
ssao_enabled = true

[node name="MainMenu" type="Node3D"]

[node name="CanvasLayer" type="CanvasLayer" parent="."]

[node name="VBoxContainer" type="VBoxContainer" parent="CanvasLayer"]
anchors_preset = 8
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
offset_left = -418.0
offset_top = -209.5
offset_right = 418.0
offset_bottom = 209.5
grow_horizontal = 2
grow_vertical = 2
theme_override_constants/separation = 48

[node name="Create Game" type="MarginContainer" parent="CanvasLayer/VBoxContainer"]
layout_mode = 2
size_flags_horizontal = 4
size_flags_vertical = 4
theme_override_constants/margin_left = 256
theme_override_constants/margin_right = 256

[node name="Button" parent="CanvasLayer/VBoxContainer/Create Game" instance=ExtResource("1_uhagc")]
layout_mode = 2
scene = ExtResource("2_wb0q5")

[node name="Load Game" type="MarginContainer" parent="CanvasLayer/VBoxContainer"]
layout_mode = 2
size_flags_horizontal = 4
size_flags_vertical = 4

[node name="Button" parent="CanvasLayer/VBoxContainer/Load Game" instance=ExtResource("1_uhagc")]
layout_mode = 2
text = "Load Game"
scene = ExtResource("2_wb0q5")
should_load_save_file = true

[node name="Exit" type="MarginContainer" parent="CanvasLayer/VBoxContainer"]
layout_mode = 2
size_flags_horizontal = 4
size_flags_vertical = 4

[node name="Button" type="Button" parent="CanvasLayer/VBoxContainer/Exit"]
layout_mode = 2
theme_override_fonts/font = ExtResource("3_q85j6")
theme_override_font_sizes/font_size = 64
theme_override_styles/normal = SubResource("StyleBoxFlat_8g5eo")
theme_override_styles/pressed = SubResource("StyleBoxFlat_wb0q5")
theme_override_styles/hover = SubResource("StyleBoxFlat_q85j6")
theme_override_styles/disabled = SubResource("StyleBoxFlat_7suek")
theme_override_styles/focus = SubResource("StyleBoxFlat_otr3d")
text = "Exit"
script = ExtResource("4_q85j6")

[node name="CycleController" type="Node3D" parent="." node_paths=PackedStringArray("sun_light", "world_environment")]
script = SubResource("GDScript_tel4y")
day_data = SubResource("Resource_n4uci")
night_data = ExtResource("11_otr3d")
sun_light = NodePath("Sun")
world_environment = NodePath("WorldEnvironment")
show_debug_time = null
metadata/_custom_type_script = "uid://sqer1ykwxtg5"

[node name="Sun" type="DirectionalLight3D" parent="CycleController"]
transform = Transform3D(-0.8660254, -0.3050726, 0.39614487, 0, 0.7922896, 0.61014515, -0.50000006, 0.5284012, -0.6861429, 0, 0, 4.7846985)
light_color = Color(1, 1, 0.98039216, 1)
shadow_enabled = true
shadow_reverse_cull_face = true
shadow_blur = 0.0

[node name="WorldEnvironment" type="WorldEnvironment" parent="CycleController"]
environment = SubResource("Environment_877pj")
script = ExtResource("12_n4uci")
day_cover = ExtResource("13_877pj")
night_cover = ExtResource("14_ayp64")

[node name="Environment" type="Node3D" parent="."]

[node name="Terrain" parent="Environment" instance=ExtResource("1_fe2o3")]

[node name="House1" parent="Environment" instance=ExtResource("3_m1kxf")]
transform = Transform3D(0.59482276, 0, -0.80385685, 0, 1, 0, 0.80385685, 0, 0.59482276, 32.889, 7.122, -3.967)

[node name="House2" parent="Environment" instance=ExtResource("3_m1kxf")]
transform = Transform3D(0.9205048, 0, 0.3907311, 0, 1, 0, -0.3907311, 0, 0.9205048, 25.189, 6.992, -8.832)

[node name="Tree1" parent="Environment" instance=ExtResource("4_x2yvf")]
transform = Transform3D(0.8660254, 0, -0.5, 0, 1, 0, 0.5, 0, 0.8660254, 28, 7.134019, -10)

[node name="Tree4" parent="Environment" instance=ExtResource("4_x2yvf")]
transform = Transform3D(0.8660254, 0, -0.5, 0, 1, 0, 0.5, 0, 0.8660254, 35, 8.171981, -25)

[node name="Tree2" parent="Environment" instance=ExtResource("4_x2yvf")]
transform = Transform3D(0.258819, 0, -0.9659258, 0, 1, 0, 0.9659258, 0, 0.258819, 34, 6.926034, -2)

[node name="Tree6" parent="Environment" instance=ExtResource("4_x2yvf")]
transform = Transform3D(0.258819, 0, -0.9659258, 0, 1, 0, 0.9659258, 0, 0.258819, 34, 7.9461784, -19)

[node name="Tree3" parent="Environment" instance=ExtResource("4_x2yvf")]
transform = Transform3D(-0.70710695, 0, -0.70710677, 0, 1, 0, 0.70710677, 0, -0.70710695, 23, 6.5601234, -7)

[node name="Tree5" parent="Environment" instance=ExtResource("4_x2yvf")]
transform = Transform3D(-0.70710695, 0, -0.70710677, 0, 1, 0, 0.70710677, 0, -0.70710695, 41, 8.120825, -23)

[node name="SawMill" parent="Environment" instance=ExtResource("5_x2yvf")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 37, 8, -21)

[node name="Camera3D" type="Camera3D" parent="."]
transform = Transform3D(0.9804365, 0.0022256717, -0.19682328, 0, 0.9999361, 0.011307248, 0.19683588, -0.011086037, 0.9803738, 27.879145, 8.353338, 0.20375824)

[connection signal="day_started" from="CycleController" to="CycleController/WorldEnvironment" method="_on_cycle_controller_day_started"]
[connection signal="night_started" from="CycleController" to="CycleController/WorldEnvironment" method="_on_cycle_controller_night_started"]
